# Semgrep CE Security Scan Workflow
name: Semgrep Security Scan

on:
  # Scan pull requests
  pull_request:
    types: [opened, synchronize, reopened]
    
  # On-demand scan through GitHub Actions interface
  workflow_dispatch:
    inputs:
      config:
        description: 'Semgrep config to use'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'p/security-audit'
          - 'p/owasp-top-10'
          - 'p/cwe-top-25'
          - 'p/r2c-security-audit'
      severity:
        description: 'Minimum severity level'
        required: false
        default: 'INFO'
        type: choice
        options:
          - 'INFO'
          - 'WARNING' 
          - 'ERROR'
      exclude_paths:
        description: 'Paths to exclude (comma-separated)'
        required: false
        default: ''
        
  # Scan main branches on push
  push:
    branches: 
      - main
      - develop
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      
  # Scheduled daily scan
  schedule:
    - cron: '0 15 * * *'  # Daily at 15:00 UTC (00:00 JST)

# Minimal required permissions
permissions:
  contents: read
  security-events: write  # For SARIF upload
  pull-requests: write    # For PR comments


jobs:
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    
    # Skip scans for dependabot and draft PRs
    if: |
      github.actor != 'dependabot[bot]' && 
      github.actor != 'dependabot-preview[bot]' &&
      !github.event.pull_request.draft
    
    container:
      image: semgrep/semgrep:latest
      
    outputs:
      findings-count: ${{ steps.count-findings.outputs.findings-count }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Full history for better analysis
          
      - name: Set scan parameters
        id: params
        run: |
          # Set config based on trigger type and inputs
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "config=${{ github.event.inputs.config || 'auto' }}" >> $GITHUB_OUTPUT
            echo "severity=${{ github.event.inputs.severity || 'INFO' }}" >> $GITHUB_OUTPUT
            echo "exclude_paths=${{ github.event.inputs.exclude_paths }}" >> $GITHUB_OUTPUT
          else
            echo "config=auto" >> $GITHUB_OUTPUT
            echo "severity=INFO" >> $GITHUB_OUTPUT
            echo "exclude_paths=" >> $GITHUB_OUTPUT
          fi
          
      - name: Run Semgrep scan
        id: scan
        run: |
          set -e
          
          # Build scan command
          SCAN_CMD="semgrep scan --config=${{ steps.params.outputs.config }}"
          SCAN_CMD="$SCAN_CMD --severity=${{ steps.params.outputs.severity }}"
          SCAN_CMD="$SCAN_CMD --json --output=semgrep-results.json"
          SCAN_CMD="$SCAN_CMD --sarif --sarif-output=semgrep-results.sarif"
          SCAN_CMD="$SCAN_CMD --timeout-threshold=3"
          
          # Add exclude paths if specified
          if [ -n "${{ steps.params.outputs.exclude_paths }}" ]; then
            IFS=',' read -ra EXCLUDES <<< "${{ steps.params.outputs.exclude_paths }}"
            for exclude in "${EXCLUDES[@]}"; do
              SCAN_CMD="$SCAN_CMD --exclude=${exclude// /}"
            done
          fi
          
          # Default exclusions
          SCAN_CMD="$SCAN_CMD --exclude=node_modules/ --exclude=vendor/ --exclude=.git/"
          
          echo "Running: $SCAN_CMD"
          
          # Run scan and capture results
          if eval "$SCAN_CMD"; then
            echo "‚úÖ Semgrep scan completed successfully"
            EXIT_CODE=0
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 1 ]; then
              echo "‚ö†Ô∏è Semgrep found issues (exit code 1)"
            else
              echo "‚ùå Semgrep scan failed with exit code $EXIT_CODE"
              exit $EXIT_CODE
            fi
          fi
          
      - name: Count findings and set output
        if: always() && hashFiles('semgrep-results.json') != ''
        id: count-findings
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const results = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
              const findingsCount = results.results ? results.results.length : 0;
              
              core.setOutput('findings-count', findingsCount);
              core.info(`Found ${findingsCount} security findings`);
              
              return findingsCount;
            } catch (error) {
              core.setOutput('findings-count', 0);
              core.warning('Could not parse semgrep results, assuming 0 findings');
              return 0;
            }
          
      - name: Upload SARIF results
        if: always() && hashFiles('semgrep-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
          
      - name: Upload scan results as artifact
        if: always() && hashFiles('semgrep-results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ github.run_id }}
          path: |
            semgrep-results.json
            semgrep-results.sarif
          retention-days: 30
          
      - name: Comment on PR
        if: |
          github.event_name == 'pull_request' && 
          steps.count-findings.outputs.findings-count != '0' &&
          hashFiles('semgrep-results.json') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
            const findingsCount = results.results ? results.results.length : 0;
            
            if (findingsCount === 0) return;
            
            const severityCounts = (results.results || []).reduce((acc, result) => {
              const severity = result.extra?.severity || 'UNKNOWN';
              acc[severity] = (acc[severity] || 0) + 1;
              return acc;
            }, {});
            
            const summaryLines = Object.entries(severityCounts)
              .map(([severity, count]) => `- ${severity}: ${count}`)
              .join('\n');
            
            const body = `## üîç Semgrep Security Scan Results
            
            Found **${findingsCount}** security finding(s):
            
            ${summaryLines}
            
            üìã View detailed results in the [Security tab](${context.payload.repository.html_url}/security/code-scanning) or check the workflow artifacts.
            
            <details>
            <summary>Top 3 Findings</summary>
            
            ${(results.results || []).slice(0, 3).map(result => 
              `**${result.check_id}** (${result.extra?.severity || 'UNKNOWN'})\n` +
              `üìç \`${result.path}:${result.start?.line || 'N/A'}\`\n` +
              `üí° ${result.extra?.message || 'No message available'}\n`
            ).join('\n---\n')}
            
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
      - name: Fail on high severity findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('semgrep-results.json')) {
              return;
            }
            
            try {
              const results = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
              const highSeverityCount = (results.results || []).filter(
                result => result.extra?.severity === 'ERROR'
              ).length;
              
              if (highSeverityCount > 0) {
                core.setFailed(`‚ùå Found ${highSeverityCount} high severity (ERROR) findings. Please review and fix these issues before merging.`);
              }
            } catch (error) {
              core.warning('Could not parse semgrep results for severity check');
            }